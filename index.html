<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Salt Whisperer</title>
<style>
:root{
 --bgA:#0b1220;--bgB:#14244b;--card:#fff;--text:#0f172a;
 --high:#dc2626;--mod:#f59e0b;--low:#16a34a;--smart:#22c55e;
 --radius:26px;--shadow:0 18px 50px rgba(0,0,0,.35);
}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:linear-gradient(135deg,var(--bgA),var(--bgB));color:#e5e7eb;overflow:hidden}
.app{max-width:560px;margin:auto;height:100dvh;display:flex;flex-direction:column;padding:14px;gap:10px}
header{display:flex;justify-content:space-between;align-items:flex-start}
.logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#60a5fa,#a78bfa);display:grid;place-items:center;font-weight:900;font-size:20px}
h1{margin:0;font-size:20px}
.sub{font-size:13px;opacity:.85}
.hud{font-size:13px;text-align:right}
.progress{height:12px;background:rgba(255,255,255,.15);border-radius:999px;overflow:hidden}
.progress div{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#a78bfa)}
.stack{flex:1;position:relative}

.card{
 position:absolute;inset:0;background:var(--card);color:var(--text);
 border-radius:var(--radius);box-shadow:var(--shadow);
 padding:22px;display:flex;flex-direction:column;justify-content:space-between;
 touch-action:none;will-change:transform,opacity;
 transition:transform 180ms ease,opacity 180ms ease;
 transform:translate3d(0,0,0);
}
.card.dragging{transition:none}

.visual{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:12px}
.emoji{font-size:84px;line-height:1}
.name{font-size:30px;font-weight:900}
.prompt{font-size:16px;color:#475569}

.badges{display:flex;justify-content:space-between}
.badge{font-size:12px;font-weight:900;padding:6px 12px;border-radius:999px}
.smart{background:rgba(34,197,94,.15);color:#065f46}
.modeTag{background:rgba(96,165,250,.18);color:#1e40af}

.parts{margin-top:10px;width:100%}
.part{background:#f1f5f9;border-radius:16px;padding:10px 14px;margin-bottom:8px;font-size:15px;text-align:center}

.compareGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;margin-top:10px}
.compareBox{background:#f8fafc;border:2px solid rgba(148,163,184,.4);border-radius:18px;padding:12px;text-align:center}
.compareTitle{font-weight:900;font-size:16px}
.compareSub{font-size:12px;color:#475569;margin-top:4px}

.controls{display:flex;gap:10px}
button{flex:1;border:0;border-radius:999px;padding:16px;font-weight:900;font-size:15px}
.high{background:rgba(220,38,38,.15);color:#fecaca}
.mod{background:rgba(245,158,11,.15);color:#fde68a}
.low{background:rgba(22,163,74,.15);color:#bbf7d0}

.toast{background:rgba(2,6,23,.72);border-radius:18px;padding:16px;font-size:14px;display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.panel{background:rgba(15,23,42,.95);padding:24px;border-radius:26px;max-width:440px;text-align:center}
.panel button{margin-top:10px;padding:10px 18px}
.toggleRow{display:flex;gap:6px;flex-wrap:wrap}
.toggle{padding:6px 12px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.3);cursor:pointer;user-select:none}
.toggle.on{background:#22c55e;color:#052e16;border-color:#22c55e}
.footer{font-size:11px;opacity:.75;text-align:center}
.small{font-size:12px;opacity:.85}
.kv{display:flex;justify-content:space-between;gap:12px;margin-top:6px;text-align:left}
.kv div{flex:1;background:rgba(255,255,255,.06);border-radius:14px;padding:10px}
.kv b{display:block;margin-bottom:4px}
</style>
</head>
<body>

<div class="app">
<header>
 <div style="display:flex;gap:10px">
  <div class="logo">üßÇ</div>
  <div>
    <h1>Salt Whisperer</h1>
    <div class="sub">Difficulty ramps each level ‚Ä¢ Compare Mode unlocks at Level 3</div>
  </div>
 </div>
 <div class="hud">
  Level <b id="level">1</b>/5<br/>
  <span id="rank">Rookie</span><br/>
  Card <b id="cardN">1</b>/10
 </div>
</header>

<div class="toggleRow" title="Cuisine filters (for meal cards)">
 <div class="toggle on" data-c="all">All</div>
 <div class="toggle on" data-c="american">American</div>
 <div class="toggle on" data-c="asian">Asian</div>
 <div class="toggle on" data-c="indian">Indian</div>
 <div class="toggle on" data-c="med">Mediterranean</div>

 <div style="flex:1"></div>
 <div class="toggle on" id="soundT">üîä Sound</div>
 <div class="toggle on" id="hapticT">üì≥ Haptics</div>
</div>

<div class="progress"><div id="prog"></div></div>
<div class="stack" id="stack"></div>

<div class="controls">
 <button class="high" id="btnL" onclick="answer('high')">‚¨Ö High</button>
 <button class="mod" id="btnU" onclick="answer('mod')">‚¨Ü Moderate</button>
 <button class="low" id="btnR" onclick="answer('low')">Low ‚û°</button>
</div>

<div class="toast" id="toast"></div>
<div class="footer">Educational only ‚Ä¢ Brands/recipes vary ‚Ä¢ ‚ÄúLow/No-salt-added‚Äù still needs label-checking</div>
</div>

<div class="modal" id="modal"><div class="panel" id="panel"></div></div>

<script>
const FEEDBACK_MS = 3000;
const PASS = 7;
const RANKS = ["Rookie","Whisperer","Specialist","Master","Guru"];
const DIFF = {
  1: {compare:0},
  2: {compare:0},
  3: {compare:1},
  4: {compare:1},
  5: {compare:2}
};

let level=1, idx=0, correct=0, busy=false;
let cuisines={all:true,american:true,asian:true,indian:true,med:true};
let usedFood=new Set(), usedMeal=new Set(), usedCompare=new Set();
let soundOn=true, hapticOn=true;

// Audio
let audioCtx=null;
function beep(type){
  if(!soundOn) return;
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type="sine";
    o.frequency.value = type==="good" ? 660 : 220;
    g.gain.value = 0.0001;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    const t=audioCtx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.12, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.16);
    o.stop(t+0.18);
  }catch(e){}
}
function haptic(ms=20){
  if(!hapticOn) return;
  if(navigator.vibrate) navigator.vibrate(ms);
}

// Foods (>=35 unique)
const FOODS=[
 {id:"eggs",n:"Eggs",e:"üç≥",c:"low",t:"Naturally low sodium."},
 {id:"oat",n:"Oatmeal (plain)",e:"ü•£",c:"low",t:"Plain oats are sodium-friendly."},
 {id:"banana",n:"Banana",e:"üçå",c:"low",t:"Fresh fruit is naturally low sodium."},
 {id:"apple",n:"Apple",e:"üçé",c:"low",t:"Fresh fruit is naturally low sodium."},
 {id:"bread",n:"Bread",e:"üçû",c:"mod",t:"Hidden sodium in dough."},
 {id:"bagel",n:"Bagel",e:"ü•Ø",c:"high",t:"Dense breads carry more salt."},
 {id:"tortilla",n:"Tortilla",e:"üåØ",c:"mod",t:"Tortillas often have surprising sodium."},
 {id:"rice",n:"Rice",e:"üçö",c:"low",t:"Plain rice is low sodium."},
 {id:"pasta",n:"Pasta (plain)",e:"üçù",c:"low",t:"Plain pasta is low sodium (sauce matters)."},
 {id:"deli",n:"Deli Meat",e:"ü•™",c:"high",t:"Processed meats are salty."},
 {id:"bacon",n:"Bacon",e:"ü•ì",c:"high",t:"Cured meats are sodium-heavy."},
 {id:"sausage",n:"Sausage",e:"üå≠",c:"high",t:"Processed meats usually pack sodium."},
 {id:"soup",n:"Canned Soup",e:"ü•´",c:"high",t:"Liquid foods can hide lots of salt."},
 {id:"broth",n:"Broth/Stock",e:"üç≤",c:"high",t:"Broths can be extremely salty unless low-sodium."},
 {id:"lowbroth",n:"Low-sodium Broth",e:"üç≤",c:"mod",t:"Better‚Äîstill check the label."},
 {id:"cheese",n:"Cheese",e:"üßÄ",c:"mod",t:"Salt is part of cheese."},
 {id:"chips",n:"Chips",e:"ü•î",c:"high",t:"Engineered for salt cravings."},
 {id:"pretzels",n:"Pretzels",e:"ü•®",c:"high",t:"Salted snack‚Äîoften high sodium."},
 {id:"nuts_unsalted",n:"Nuts (unsalted)",e:"ü•ú",c:"low",t:"Unsalted nuts are a smart snack."},
 {id:"nuts_salted",n:"Nuts (salted)",e:"ü•ú",c:"mod",t:"Salted versions add sodium quickly."},
 {id:"veg",n:"Vegetables (fresh)",e:"ü•¶",c:"low",t:"Fresh veggies are naturally low sodium."},
 {id:"pickles",n:"Pickles",e:"ü•í",c:"high",t:"Brined foods are sodium bombs."},
 {id:"soy",n:"Soy Sauce",e:"ü•¢",c:"high",t:"Concentrated sodium‚Äîuse sparingly."},
 {id:"lowssoy",n:"Low-sodium Soy Sauce",e:"ü•¢",c:"mod",t:"Lower, but still salty."},
 {id:"ketchup",n:"Ketchup",e:"üçÖ",c:"mod",t:"Condiments add up fast."},
 {id:"bbq",n:"BBQ Sauce",e:"üçñ",c:"mod",t:"Sauces sneak in sodium."},
 {id:"salad_dress",n:"Salad Dressing",e:"ü•ó",c:"mod",t:"Dressings can be salty‚Äîportion matters."},
 {id:"frozen_dinner",n:"Frozen Dinner",e:"üç±",c:"high",t:"Often designed with lots of sodium."},
 {id:"ramen_pack",n:"Ramen Packet",e:"üçú",c:"high",t:"Seasoning packet is the salt."},
 {id:"cottage",n:"Cottage Cheese",e:"ü•õ",c:"mod",t:"Often higher sodium than expected."},
 {id:"yogurt",n:"Yogurt (plain)",e:"ü•õ",c:"low",t:"Plain yogurt is usually low sodium."},
 {id:"breaded_chx",n:"Breaded Chicken",e:"üçó",c:"mod",t:"Breading adds sodium."},
 {id:"rotisserie",n:"Rotisserie Chicken",e:"üçó",c:"high",t:"Often injected with salty brine."},
 {id:"tuna_can",n:"Canned Tuna (regular)",e:"üêü",c:"mod",t:"Canned proteins vary‚Äîcheck label."},
 {id:"tuna_low",n:"Canned Tuna (low sodium)",e:"üêü",c:"low",t:"Low-sodium versions are a smart swap."},
 {id:"beans_can",n:"Canned Beans (regular)",e:"ü´ò",c:"mod",t:"Rinse to reduce sodium."},
 {id:"beans_nsa",n:"Beans (No-salt-added)",e:"ü´ò",c:"low",t:"No-salt-added is a high-value swap."},
 {id:"tomato_can",n:"Canned Tomatoes (regular)",e:"üçÖ",c:"mod",t:"Many canned veggies have added salt."},
 {id:"tomato_nsa",n:"Tomatoes (No-salt-added)",e:"üçÖ",c:"low",t:"No-salt-added is the win."},
];

// Meals (40+ unique)
const MEALS=[
 {id:"am_chx_plate",n:"Grilled Chicken Plate",e:"üçó",c:"low",s:true,cu:"american",p:["Chicken","Rice","Vegetables"],t:"Repeatable low-sodium dinner."},
 {id:"am_burger_combo",n:"Fast-food Burger Combo",e:"üçî",c:"high",cu:"american",p:["Burger","Fries","Sauce"],t:"Stacked salt from multiple items."},
 {id:"am_home_burger",n:"Homemade Burger + Oven Fries",e:"üçî",c:"mod",s:true,cu:"american",p:["Burger","Oven fries"],t:"Home prep lowers sodium ceiling."},
 {id:"am_pizza",n:"Pizza Night",e:"üçï",c:"high",cu:"american",p:["Pizza","Extra cheese"],t:"Crust, sauce, cheese = sodium stack."},
 {id:"am_breakfast",n:"Breakfast-for-Dinner",e:"üç≥",c:"mod",s:true,cu:"american",p:["Eggs","Toast","Fruit"],t:"Solid meal‚Äîwatch the bread."},
 {id:"am_soup_sand",n:"Soup + Deli Sandwich",e:"ü•™",c:"high",cu:"american",p:["Soup","Deli sandwich"],t:"Liquid + deli meats stack salt."},
 {id:"am_grill_fish",n:"Baked Fish + Potatoes",e:"üêü",c:"low",s:true,cu:"american",p:["Fish","Potatoes","Salad"],t:"Simple cooking keeps sodium predictable."},
 {id:"am_fried_chx",n:"Fried Chicken Dinner",e:"üçó",c:"high",cu:"american",p:["Fried chicken","Sides"],t:"Breading + sides raise sodium."},
 {id:"am_chili",n:"Chili (Canned)",e:"ü•£",c:"high",cu:"american",p:["Canned chili"],t:"Canned meals are usually high sodium."},
 {id:"am_chili_home",n:"Chili (Home, low-salt)",e:"ü•£",c:"mod",s:true,cu:"american",p:["No-salt-added beans","Spices"],t:"No-salt-added beans are a power move."},
 {id:"am_mac",n:"Mac & Cheese (Boxed)",e:"üßÄ",c:"high",cu:"american",p:["Boxed pasta","Cheese mix"],t:"Packets carry sodium."},

 {id:"as_teriyaki",n:"Teriyaki Bowl",e:"üçú",c:"high",cu:"asian",p:["Chicken","Sauce","Rice"],t:"Sauce is the main sodium source."},
 {id:"as_stirfry_ls",n:"Stir Fry (Light Sauce)",e:"ü•¶",c:"mod",s:true,cu:"asian",p:["Veg","Protein","Light sauce"],t:"Light sauce = big sodium savings."},
 {id:"as_pho_lessbroth",n:"Pho (Less Broth)",e:"üçú",c:"mod",s:true,cu:"asian",p:["Noodles","Herbs","Less broth"],t:"Broth control makes this workable."},
 {id:"as_ramen_full",n:"Ramen (Full Broth)",e:"üçú",c:"high",cu:"asian",p:["Noodles","Broth","Seasoning"],t:"Most sodium is in broth/packet."},
 {id:"as_sushi",n:"Sushi + Soy Sauce",e:"üç£",c:"mod",cu:"asian",p:["Sushi","Soy sauce"],t:"Soy sauce is concentrated sodium."},
 {id:"as_sushi_lows",n:"Sushi + Low-sodium Soy",e:"üç£",c:"mod",s:true,cu:"asian",p:["Sushi","Low-sodium soy"],t:"Better‚Äîstill use lightly."},
 {id:"as_padthai",n:"Pad Thai (Restaurant)",e:"üçú",c:"high",cu:"asian",p:["Noodles","Sauce"],t:"Restaurant sauces are salty."},
 {id:"as_rice_bowl",n:"Rice Bowl (Home)",e:"üçö",c:"low",s:true,cu:"asian",p:["Rice","Protein","Veg"],t:"Home bowls keep sodium controllable."},
 {id:"as_miso",n:"Miso Soup",e:"üç≤",c:"high",cu:"asian",p:["Miso broth"],t:"Miso is salty by design."},
 {id:"as_bibimbap",n:"Bibimbap (Restaurant)",e:"üçö",c:"mod",cu:"asian",p:["Rice","Veg","Sauce"],t:"Sauce drives sodium."},
 {id:"as_friedrice",n:"Fried Rice (Takeout)",e:"üçö",c:"high",cu:"asian",p:["Soy sauce","Oil"],t:"Soy sauce drives sodium."},

 {id:"in_dal_rice",n:"Dal + Rice (Home)",e:"ü•£",c:"low",s:true,cu:"indian",p:["Dal","Rice","Yogurt"],t:"Spices give flavor without salt."},
 {id:"in_butterchx",n:"Butter Chicken + Naan",e:"üçõ",c:"high",cu:"indian",p:["Sauce","Naan"],t:"Restaurant sauces add salt."},
 {id:"in_chana",n:"Chana Masala (Home)",e:"üç≤",c:"mod",s:true,cu:"indian",p:["Chana","Spices"],t:"Salt varies‚Äîhome cooking helps."},
 {id:"in_biryani",n:"Biryani (Restaurant)",e:"üçõ",c:"mod",cu:"indian",p:["Rice","Spices"],t:"Often moderate‚Äîportion matters."},
 {id:"in_idli",n:"Idli + Sambar",e:"ü•ü",c:"mod",cu:"indian",p:["Idli","Sambar"],t:"Depends on sambar salt‚Äîrecipe matters."},
 {id:"in_upma",n:"Upma (Home)",e:"ü•£",c:"low",s:true,cu:"indian",p:["Semolina","Veg"],t:"Home prep keeps sodium low."},
 {id:"in_tikka",n:"Chicken Tikka (Restaurant)",e:"üç¢",c:"mod",cu:"indian",p:["Chicken","Spices"],t:"Often moderate‚Äîwatch sauces/sides."},
 {id:"in_papad",n:"Papad + Pickles",e:"ü•î",c:"high",cu:"indian",p:["Papad","Pickles"],t:"Pickles are high sodium."},
 {id:"in_samosa",n:"Samosa Plate",e:"ü•ü",c:"high",cu:"indian",p:["Fried snack","Chutney"],t:"Fried + chutney = sodium stack."},
 {id:"in_khichdi",n:"Khichdi (Home)",e:"ü•£",c:"low",s:true,cu:"indian",p:["Lentils","Rice","Spices"],t:"Comfort food that can stay low sodium."},

 {id:"md_bowl",n:"Mediterranean Bowl",e:"ü•ó",c:"mod",s:true,cu:"med",p:["Chicken","Veg","Tzatziki"],t:"Sauce on side helps a lot."},
 {id:"md_gyro",n:"Gyro Plate",e:"ü•ô",c:"high",cu:"med",p:["Meat","Sauce"],t:"Processed meat adds sodium."},
 {id:"md_fish_plate",n:"Grilled Fish Plate",e:"üêü",c:"low",s:true,cu:"med",p:["Fish","Potatoes","Salad"],t:"Simple prep keeps sodium low."},
 {id:"md_hummus_pita",n:"Hummus + Pita",e:"ü´ì",c:"mod",cu:"med",p:["Hummus","Bread"],t:"Bread + dip can add up."},
 {id:"md_greek_salad",n:"Greek Salad (Restaurant)",e:"ü•ó",c:"mod",cu:"med",p:["Feta","Olives","Dressing"],t:"Feta/olives add sodium."},
 {id:"md_greek_salad_home",n:"Greek Salad (Home, lite feta)",e:"ü•ó",c:"low",s:true,cu:"med",p:["Veg","Lite feta","Oil/lemon"],t:"Home tweaks = big sodium win."},
 {id:"md_shakshuka",n:"Shakshuka (Home)",e:"üç≥",c:"low",s:true,cu:"med",p:["Eggs","Tomato","Spices"],t:"Flavor without heavy sodium."},
 {id:"md_olives",n:"Olives + Cheese Plate",e:"ü´í",c:"high",cu:"med",p:["Olives","Cheese"],t:"Brined + salted foods stack."},
 {id:"md_falafel",n:"Falafel Wrap",e:"üåØ",c:"mod",cu:"med",p:["Falafel","Sauce"],t:"Portion and sauce matter."},
 {id:"md_falafel_home",n:"Falafel Bowl (Home)",e:"ü•ó",c:"mod",s:true,cu:"med",p:["Falafel","Veg","Lemon"],t:"Home sauces keep sodium controlled."},
];

// Compare cards (brand/label training)
const COMPARES = [
 {id:"cmp_beans",cu:"american",a:{name:"Canned beans (regular)",sub:"~400 mg/serving",mg:400}, b:{name:"Beans (no-salt-added)",sub:"~10 mg/serving",mg:10}, teach:"No-salt-added is a huge win. Rinse regular beans to reduce sodium."},
 {id:"cmp_tomatoes",cu:"american",a:{name:"Canned tomatoes (regular)",sub:"~300 mg/serving",mg:300}, b:{name:"No-salt-added tomatoes",sub:"~15 mg/serving",mg:15}, teach:"Same food, totally different sodium. ‚ÄòNo-salt-added‚Äô is your friend."},
 {id:"cmp_broth",cu:"american",a:{name:"Regular broth",sub:"~800 mg/cup",mg:800}, b:{name:"Low-sodium broth",sub:"~140 mg/cup",mg:140}, teach:"Broth is one of the sneakiest sodium sources. Low-sodium is a big upgrade."},
 {id:"cmp_burger",cu:"american",a:{name:"Fast-food burger combo",sub:"~1500 mg",mg:1500}, b:{name:"Home burger + oven fries",sub:"~650 mg",mg:650}, teach:"Same vibe, different sodium. Home prep lowers the ceiling."},
 {id:"cmp_soy",cu:"asian",a:{name:"Regular soy sauce",sub:"~900 mg/Tbsp",mg:900}, b:{name:"Low-sodium soy sauce",sub:"~500 mg/Tbsp",mg:500}, teach:"‚ÄòLow-sodium‚Äô helps‚Äîbut it‚Äôs still salty. Use lightly."},
 {id:"cmp_tuna",cu:"american",a:{name:"Canned tuna (regular)",sub:"~300 mg",mg:300}, b:{name:"Canned tuna (low sodium)",sub:"~60 mg",mg:60}, teach:"Protein swaps like this add up over a week."},
 {id:"cmp_soup",cu:"american",a:{name:"Canned soup",sub:"~900 mg/cup",mg:900}, b:{name:"Low-sodium soup",sub:"~350 mg/cup",mg:350}, teach:"Low-sodium versions are often ‚Äòmoderate‚Äô‚Äîstill check labels."},
];

// DOM
const stack=document.getElementById("stack");
const toast=document.getElementById("toast");
const modal=document.getElementById("modal");
const panel=document.getElementById("panel");
const btnL=document.getElementById("btnL");
const btnU=document.getElementById("btnU");
const btnR=document.getElementById("btnR");

function shuffle(a){return [...a].sort(()=>Math.random()-.5);}
function activeMeals(){ return cuisines.all ? MEALS : MEALS.filter(m=>cuisines[m.cu]); }
function activeCompares(){ return cuisines.all ? COMPARES : COMPARES.filter(x=>cuisines[x.cu]); }

let round=[];

function pickFoods(n){
 let pool=FOODS.filter(f=>!usedFood.has(f.id));
 if(pool.length<n) pool=FOODS;
 return shuffle(pool).slice(0,n).map(f=>{usedFood.add(f.id); return {type:"food",...f};});
}
function pickMeals(nMeals){
 let pool=activeMeals().filter(m=>!usedMeal.has(m.id));
 if(pool.length<nMeals) pool=activeMeals();
 const smartPool=pool.filter(m=>m.s);
 const otherPool=pool.filter(m=>!m.s);
 const smart=shuffle(smartPool).slice(0,1);
 const others=shuffle(otherPool).slice(0,nMeals-1);
 [...smart,...others].forEach(m=>usedMeal.add(m.id));
 return [...smart.map(m=>({type:"meal",...m})),...others.map(m=>({type:"meal",...m}))];
}
function pickCompares(n){
 let pool=activeCompares().filter(x=>!usedCompare.has(x.id));
 if(pool.length<n) pool=activeCompares();
 return shuffle(pool).slice(0,n).map(x=>{usedCompare.add(x.id); return {type:"compare",...x};});
}

function buildRoundForLevel(lv){
 const nCompare = DIFF[lv].compare;
 const nFoods = nCompare ? (7 - nCompare) : 7;
 const foods = pickFoods(nFoods);
 const meals = pickMeals(3);
 const compares = nCompare ? pickCompares(nCompare) : [];
 return shuffle([...foods,...meals,...compares]).slice(0,10);
}

function setControlsFor(card){
 if(card.type==="compare"){
   btnL.textContent="‚¨Ö Pick Left";
   btnU.textContent="‚¨Ü Tie";
   btnR.textContent="Pick Right ‚û°";
 } else {
   btnL.textContent="‚¨Ö High";
   btnU.textContent="‚¨Ü Moderate";
   btnR.textContent="Low ‚û°";
 }
}

function render(){
 stack.innerHTML=""; toast.style.display="none";
 const c=round[idx];
 document.getElementById("level").textContent=level;
 document.getElementById("rank").textContent=RANKS[level-1];
 document.getElementById("cardN").textContent=idx+1;
 document.getElementById("prog").style.width=(idx/10*100)+"%";
 setControlsFor(c);

 const el=document.createElement("div");
 el.className="card";

 if(c.type==="compare"){
   el.innerHTML=`
    <div class="badges">
      <div class="badge modeTag">COMPARE MODE</div>
      <div class="badge">${c.cu.toUpperCase()}</div>
    </div>
    <div class="visual">
      <div class="emoji">üÜö</div>
      <div class="name">Which is LOWER sodium?</div>
      <div class="prompt">Swipe left/right to choose ‚Ä¢ Swipe up if about the same</div>
      <div class="compareGrid">
        <div class="compareBox">
          <div class="compareTitle">${c.a.name}</div>
          <div class="compareSub">${c.a.sub}</div>
        </div>
        <div class="compareBox">
          <div class="compareTitle">${c.b.name}</div>
          <div class="compareSub">${c.b.sub}</div>
        </div>
      </div>
    </div>
   `;
 } else {
   el.innerHTML=`
    <div class="badges">
      <div class="badge">${c.type}</div>
      ${c.s?'<div class="badge smart">SMART</div>':''}
    </div>
    <div class="visual">
      <div class="emoji">${c.e}</div>
      <div class="name">${c.n}</div>
      <div class="prompt">What‚Äôs the sodium level?</div>
    </div>
    ${c.p?'<div class="parts">'+c.p.map(x=>'<div class="part">'+x+'</div>').join("")+'</div>':""}
   `;
 }
 stack.appendChild(el);
 enableSwipe(el);
}

function enableSwipe(cardEl){
 let sx=0, sy=0, dx=0, dy=0, dragging=false;
 let pending=false;

 function apply(){
   pending=false;
   const rot = dx/28;
   const opacity = Math.max(0.35, 1 - Math.min(1, Math.abs(dx)/520));
   cardEl.style.transform = `translate3d(${dx}px,${dy}px,0) rotate(${rot}deg)`;
   cardEl.style.opacity = opacity;
 }
 function schedule(){ if(pending) return; pending=true; requestAnimationFrame(apply); }

 cardEl.onpointerdown = e => {
   if(busy) return;
   dragging=true; sx=e.clientX; sy=e.clientY; dx=0; dy=0;
   cardEl.classList.add("dragging");
   cardEl.setPointerCapture(e.pointerId);
 };
 cardEl.onpointermove = e => {
   if(!dragging) return;
   dx=e.clientX-sx; dy=e.clientY-sy;
   schedule();
 };
 cardEl.onpointerup = e => {
   if(!dragging) return;
   dragging=false;
   cardEl.classList.remove("dragging");

   const horiz = Math.abs(dx) > Math.abs(dy);
   const doLeft = horiz && dx<-120;
   const doRight = horiz && dx>120;
   const doUp = !horiz && dy<-120;

   if(doLeft || doRight || doUp){
     const w=Math.max(window.innerWidth, 700);
     const h=Math.max(window.innerHeight, 900);
     const offX = doLeft ? -w : (doRight ? w : dx);
     const offY = doUp ? -h : dy;
     cardEl.style.transform = `translate3d(${offX}px,${offY}px,0) rotate(${dx/22}deg)`;
     cardEl.style.opacity = 0;

     const c = round[idx];
     if(c.type==="compare"){
       if(doLeft) answer("A");
       else if(doRight) answer("B");
       else answer("TIE");
     } else {
       if(doLeft) answer("high");
       else if(doRight) answer("low");
       else answer("mod");
     }
   } else {
     dx=0; dy=0;
     cardEl.style.opacity = 1;
     cardEl.style.transform = "translate3d(0,0,0) rotate(0deg)";
   }
 };
 cardEl.onpointercancel = () => {
   dragging=false;
   cardEl.classList.remove("dragging");
   cardEl.style.opacity = 1;
   cardEl.style.transform = "translate3d(0,0,0) rotate(0deg)";
 };
}

function compareCorrect(c, choice){
 const diff=Math.abs(c.a.mg - c.b.mg);
 const tie = diff<=50 || diff<=Math.min(c.a.mg,c.b.mg)*0.10;
 if(choice==="TIE") return tie;
 const lower = c.a.mg < c.b.mg ? "A" : "B";
 return choice===lower && !tie;
}

function feedback(ok, c){
 toast.style.display="block";
 if(ok){beep("good");haptic(20);} else {beep("bad");haptic(40);}
 const headline = ok ? "‚úÖ Correct" : "‚ùå Not quite";
 const teach = c.type==="compare" ? c.teach : c.t;
 const pep = ok
   ? (c.s ? "That‚Äôs a repeatable win. üëè" : "Nice catch. Sodium spotted. üïµÔ∏è")
   : (c.type==="compare" ? "Close. Labels + brands are the whole game. Keep going." : (c.s ? "Not quite ‚Äî but this is actually a good meal üëç" : "Classic sodium trap. You‚Äôll nail it next time."));
 toast.innerHTML = `<b>${headline}</b><br/>${teach}<br/><i>${pep}</i>`;
}

function answer(choice){
 if(busy) return;
 busy=true;

 const c = round[idx];
 let ok=false;
 if(c.type==="compare") ok = compareCorrect(c, choice);
 else ok = (choice===c.c);

 if(ok) correct++;
 feedback(ok, c);

 setTimeout(()=>{
   idx++; busy=false;
   if(idx>=10) endLevel();
   else render();
 }, FEEDBACK_MS);
}

function endLevel(){
 modal.style.display="flex";
 const passed = correct>=PASS;
 if(level===5){
   panel.innerHTML = `
     <h2>üéâ Guru Achieved</h2>
     <p>You completed all 5 levels.</p>
     <div class="kv">
       <div><b>Final Level</b>${correct}/10 correct</div>
       <div><b>Skill</b>Real-world sodium instincts</div>
     </div>
     <p class="small">Pro tip: ‚ÄúNo-salt-added‚Äù and ‚ÄúLow-sodium‚Äù help‚Äîbut always verify the label.</p>
     <button onclick="restart()">Play Again</button>
   `;
 } else {
   panel.innerHTML = `
     <h2>${passed ? "Level Up üéâ" : "Try Again üîÅ"}</h2>
     <p>Score: <b>${correct}/10</b></p>
     <p>${passed ? "Welcome to <b>"+RANKS[level]+"</b>." : "You‚Äôre close ‚Äî run it back."}</p>
     <button onclick="next(${passed})">${passed ? "Next Level" : "Retry"}</button>
   `;
 }
}

function next(passed){ modal.style.display="none"; if(passed) level++; start(); }
function restart(){ modal.style.display="none"; level=1; usedFood.clear(); usedMeal.clear(); usedCompare.clear(); start(); }

function start(){ round = buildRoundForLevel(level); idx=0; correct=0; render(); }

// Cuisine toggles
document.querySelectorAll(".toggle").forEach(t=>{
 if(t.id==="soundT" || t.id==="hapticT") return;
 t.onclick=()=>{
  const c=t.dataset.c;
  if(c==="all"){Object.keys(cuisines).forEach(k=>cuisines[k]=true);}
  else cuisines[c]=!cuisines[c];
  t.classList.toggle("on");
 };
});

// Sound/Haptics toggles
document.getElementById("soundT").onclick=()=>{
 soundOn=!soundOn;
 document.getElementById("soundT").classList.toggle("on", soundOn);
};
document.getElementById("hapticT").onclick=()=>{
 hapticOn=!hapticOn;
 document.getElementById("hapticT").classList.toggle("on", hapticOn);
};

start();
</script>
</body>
</html>
